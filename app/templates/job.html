<!DOCTYPE html>
<html>
<head>
  <title>Recon Dashboard</title>
  <style>
    body{font-family:sans-serif;margin:1rem;}
    pre{background:#111;color:#eee;padding:1rem;white-space:pre-wrap;height:250px;overflow:auto;}
    .ok{color:green}
    .fail{color:red}
    .timeout{color:orange}
    .running{color:blue}
    .pending{color:gray}
    #steps td{padding:4px 8px;}
  </style>
</head>
<body>
<h1>Recon Dashboard</h1>

<p><b>Job ID:</b> {{ job_id }}</p>
<p><b>Query:</b> {{ query }}</p>

<h2>Plan (tools to run)</h2>
<pre id="plan">{{ plan }}</pre>

<h2>Live Console</h2>
<pre id="console">Connecting...</pre>

<h2>Steps</h2>
<table id="steps" border="1" cellspacing="0">
  <tr><th>Step</th><th>Status</th></tr>
  {% for s in plan | safe | load %}
  <tr id="row-{{ s['name']|replace(' ','_') }}"><td>{{ s['name'] }}</td><td class="pending">pending</td></tr>
  {% endfor %}
</table>

<p id="done" style="display:none;">
  <a href="/report/{{ job_id }}">View Final Report</a>
</p>

<script>
const jobId = "{{ job_id }}";
const proto = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${proto}://${location.host}/ws/${jobId}`);

const consoleBox = document.getElementById("console");

ws.onmessage = (evt)=>{
  try{
    const msg = JSON.parse(evt.data);
    if(msg.stream){
      consoleBox.textContent += `[${msg.step}][${msg.stream}] ${msg.data}`;
      consoleBox.scrollTop = consoleBox.scrollHeight;
    }else if(msg.event==="step_start"){
      const row = document.getElementById("row-"+msg.step.replace(/ /g,"_"));
      if(row) row.children[1].className="running", row.children[1].innerText="running";
    }else if(msg.event==="step_end"){
      const row = document.getElementById("row-"+msg.step.replace(/ /g,"_"));
      if(row) row.children[1].className=msg.status, row.children[1].innerText=msg.status;
    }else if(msg.event==="done"){
      document.getElementById("done").style.display="block";
      consoleBox.textContent += "\n[+] Job done.";
    }else if(msg.event==="fatal"){
      consoleBox.textContent += "\n[FATAL] "+msg.error;
    }
  }catch(e){
    consoleBox.textContent += "\n[WS RAW] "+evt.data;
  }
}
ws.onerror = (e)=>{
  consoleBox.textContent += "\n[WS ERROR] "+e;
}
ws.onclose = ()=> consoleBox.textContent += "\n[*] WebSocket closed";
</script>

</body>
</html>
