<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Recon Dashboard</title>
  <style>
    body{font-family:sans-serif;margin:2rem;}
    pre{background:#f4f4f4;padding:1rem;white-space:pre-wrap;max-height:200px;overflow:auto;}
    #console{background:#111;color:#0f0;padding:1rem;height:250px;overflow:auto;font:12px/1.3 monospace;}
    table{border-collapse:collapse;width:100%;margin-top:1rem;}
    th,td{border:1px solid #ccc;padding:.4rem;text-align:left;font-size:.9rem;}
    .ok{color:green;}
    .fail{color:red;}
    .timeout{color:#d58512;}
  </style>
</head>
<body>
  <h1>Recon Dashboard</h1>

  <p><b>Job ID:</b> {{ job_id }}</p>
  <p><b>Query:</b> {{ query }}</p>

  <h3>Plan (tools to run)</h3>
  <pre>{{ plan_json | tojson(indent=2) }}</pre>

  <h3>Live Console</h3>
  <div id="console">Connecting...</div>

  <h3>Steps</h3>
  <table id="steps">
    <thead><tr><th>Step</th><th>Status</th><th>Exit</th><th>Outfile</th></tr></thead>
    <tbody></tbody>
  </table>

  <p id="done" style="display:none;">
    âœ… Job finished. <a id="report-link" href="#">View report</a>
  </p>

<script>
const jobId = "{{ job_id }}";
const ws = new WebSocket(`ws://${location.host}/ws/${jobId}`);
const consoleDiv = document.getElementById('console');
const tbody = document.querySelector('#steps tbody');
const doneP = document.getElementById('done');
const reportLink = document.getElementById('report-link');

function log(msg){
  consoleDiv.textContent += msg + "\\n";
  consoleDiv.scrollTop = consoleDiv.scrollHeight;
}

ws.onopen = () => log("Connected.");
ws.onclose = () => log("[*] WebSocket closed");
ws.onerror = (e) => log("[WS ERROR] " + e);

ws.onmessage = (ev) => {
  try{
    const data = JSON.parse(ev.data);
    if(data.stream){
      log(`[${data.step}][${data.stream}] ${data.data.trim()}`);
      return;
    }
    if(data.event === "step_start"){
      const tr = document.createElement('tr');
      tr.id = 'row-'+data.step;
      tr.innerHTML = `<td>${data.step}</td><td>running</td><td></td><td></td>`;
      tbody.appendChild(tr);
    }
    if(data.event === "step_end"){
      const tr = document.getElementById('row-'+data.step);
      if(tr){
        tr.children[1].textContent = data.status;
        tr.children[1].className = data.status;
        tr.children[2].textContent = data.exit;
      }
    }
    if(data.event === "job_done"){
      doneP.style.display = 'block';
      reportLink.href = `/report/${jobId}`;
    }
    if(data.event === "error"){
      log("ERROR: " + data.msg);
    }
  }catch(err){
    log("PARSE ERROR: "+err+" raw:"+ev.data);
  }
};
</script>
</body>
</html>
